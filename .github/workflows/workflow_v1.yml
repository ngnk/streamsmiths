name: V1 Pipeline

on:
  # Run on schedule
  schedule:
    # Every 6 hours at :05 past the hour (to avoid GitHub's high-traffic periods)
    - cron: '5 */6 * * *'
  
  # Allow manual trigger from GitHub UI
  workflow_dispatch:
    inputs:
      channel_ids:
        description: 'Channel IDs (comma-separated, optional)'
        required: false
        type: string

  # Run on push to main (for testing)
  push:
    branches:
      - main
    paths:
      - '**.py'
      - '.github/workflows/pipeline.yml'

jobs:
  run-pipeline:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Prevent runaway jobs
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
    
    - name: üêç Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'  # Cache pip dependencies for faster runs
    
    - name: üì¶ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: üîë Verify secrets
      run: |
        if [ -z "${{ secrets.YOUTUBE_API_KEY }}" ]; then
          echo "‚ùå Error: YOUTUBE_API_KEY secret not set"
          exit 1
        fi
        if [ -z "${{ secrets.NEON_DATABASE_URL }}" ]; then
          echo "‚ùå Error: NEON_DATABASE_URL secret not set"
          exit 1
        fi
        echo "‚úÖ All required secrets are set"
    
    - name: ü•â BRONZE - Fetch from YouTube API
      env:
        YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
        YOUTUBE_CHANNEL_IDS: ${{ github.event.inputs.channel_ids || secrets.YOUTUBE_CHANNEL_IDS }}
      run: |
        echo "Starting Bronze layer..."
        python bronze.py
        echo "‚úÖ Bronze layer completed"
    
    - name: ü•à SILVER - Transform to Parquet
      run: |
        echo "Starting Silver layer..."
        python silver.py
        echo "‚úÖ Silver layer completed"
    
    - name: ü•á GOLD - Load to Neon
      env:
        NEON_DATABASE_URL: ${{ secrets.NEON_DATABASE_URL }}
      run: |
        echo "Starting Gold layer..."
        python gold.py
        echo "‚úÖ Gold layer completed"
    
    - name: üìä Pipeline Summary
      if: success()
      run: |
        echo "============================================"
        echo "‚úÖ Pipeline completed successfully!"
        echo "============================================"
        echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "Trigger: ${{ github.event_name }}"
        if [ -n "${{ github.event.inputs.channel_ids }}" ]; then
          echo "Channels: ${{ github.event.inputs.channel_ids }}"
        fi
        
        # Show bronze data count
        echo ""
        echo "Bronze data files created:"
        ls -lh bronze_data/ | tail -n +2 | wc -l
        
        # Show silver data sizes
        echo ""
        echo "Silver data files:"
        ls -lh silver_data/*.parquet 2>/dev/null || echo "No parquet files"
    
    - name: üì§ Upload pipeline artifacts (optional)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: pipeline-data-${{ github.run_number }}
        path: |
          bronze_data/
          silver_data/
        retention-days: 7  # Keep for 7 days for debugging
    
    - name: üí¨ Notify on failure
      if: failure()
      run: |
        echo "‚ùå Pipeline failed!"
        echo "Check the logs above for details"
        # Optional: Add Slack/Discord webhook notification here
        # curl -X POST ${{ secrets.SLACK_WEBHOOK }} -d '{"text":"Pipeline failed!"}'

    # Optional: Send success notification to Discord/Slack
    # - name: üì¢ Success notification
    #   if: success()
    #   run: |
    #     curl -X POST ${{ secrets.DISCORD_WEBHOOK }} \
    #       -H 'Content-Type: application/json' \
    #       -d '{"content":"‚úÖ YouTube pipeline completed successfully!"}'
